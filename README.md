![](https://banners.beyondco.de/Laravel-Auth-Logger.png?theme=light&packageName=spargon%2Flaravel-auth-logger&pattern=circuitBoard&style=style_2&description=Log+and+notify+users+whenever+they+access+from+new+a+device.&md=1&showWatermark=0&fontSize=100px&images=lock-closed)

[![GitHub release](https://img.shields.io/github/release/spargon/laravel-auth-logger.svg?style=for-the-badge&&colorB=7E57C2)](https://packagist.org/packages/spargon/laravel-auth-logger)
[![GitHub issues](https://img.shields.io/github/issues/Spargon/Laravel-Auth-Logger.svg?style=for-the-badge)](https://github.com/Spargon/Laravel-Auth-Logger/issues)
[![Software License](https://img.shields.io/badge/license-MIT-blue.svg?style=for-the-badge&&colorB=F27E40)](license.md)
[![GitHub repo size in bytes](https://img.shields.io/github/repo-size/Spargon/Laravel-Auth-Logger.svg?style=for-the-badge)]()
[![Total Downloads](https://img.shields.io/packagist/dt/spargon/laravel-auth-logger.svg?style=for-the-badge)](https://packagist.org/packages/spargon/laravel-auth-logger)


Laravel Auth Logger stores user authentication logs and sends out notifications whenever a user logs in from a new system.

## Installation

> Laravel Auth Logger requires PHP 7.0+ and currently supports Laravel 7, 8.

You can install the package via composer:

```bash
composer require spargon/laravel-auth-logger
```

After installing the Laravel-Auth-Logger, you can publish its config, migration & views using the `vendor:publish` command in your console:

```bash
php artisan vendor:publish --provider="Spargon\AuthLogger\AuthLoggerServiceProvider"
```

In order to store the authentication logs, you need to migrate your database. Running the command below will automatically
create the required **`auth_logs`** table for your app to use.

```bash
php artisan migrate
```

Lastly, you need to add the **`AuthLogable`** and **`Notifiable`** traits to your authenticatable model (by default its, `App\Models\User` model). These traits provides you with various methods to get the data generated by the auth logger, such as last login time, last login IP address, and sets the channels to notify the user when they login from a new device:

``` php
use Illuminate\Notifications\Notifiable;
use Spargon\AuthLogger\AuthLogable;
use Illuminate\Foundation\Auth\User as Authenticatable;

class User extends Authenticatable
{
    use Notifiable, AuthLogable;
}
```

## Usage

Get all the authentication logs for a user:

``` php
User::find(1)->auths;
```

Get the user's last login info (includes the current session if the user is logged in):

```php
User::find(1)->lastLoginAt(); [or] auth()->user()->lastLoginAt()

User::find(1)->lastLoginIp(); [or] auth()->user()->lastLoginIp()
```

Get the user's previous login time & ip address (ignoring the current login log):

```php
User::find(1)->previousLoginAt(); [or] auth()->user()->previousLoginAt()

User::find(1)->previousLoginIp(); [or] auth()->user()->lapreviousLoginIpstLoginAt()
```

### Send New Device Alert Notification

Notifications may be sent on the `mail`, and the `slack` channels. By default AuthLogger will send a notification via the mail driver (provided you have enabled `notify` in `config/auth-logger.php` file).

You can define `notifyAuthLoggerVia` method on the User's Model to determine which channels the notification should be sent to:

```php
/**
 * The Auth Logger notifications delivery channels.
 *
 * @return array
 */
public function notifyAuthLoggerVia()
{
    return ['mail', 'slack'];
}
```

Of course you can disable notifications by setting the `notify` option in your `config/auth-logger.php` configuration file to `false`:

```php
'notify' => env('AUTH_LOGGER_NOTIFY', false),
```

### User Agent Parser

This package uses the `jenssegers/agent` package to parse the user's user-agent when sending the alert notification. Take a look at their docs [here](https://github.com/jenssegers/agent) to learn how to use it in your app (ex: in your logs table).

### Delete logs after a while

You may clear the old authentication log records using the `auth-logger:clear` Artisan command:

    php artisan auth-logger:clear

Records that are older than the number of days specified in the `older` option in your `config/auth-logger.php` will be deleted when you run the above command:

```php
'older' => 31,
```

## Testing

``` bash
composer test
```

## Changelog

Please see [CHANGELOG](CHANGELOG.md) for more information on what has changed recently.

## Contributing

Please see [CONTRIBUTING](.github/CONTRIBUTING.md) for details.

## Security Vulnerabilities

Please review [our security policy](../../security/policy) on how to report security vulnerabilities.

## Credits

- [Moinuddin S. Khaja](https://github.com/TechTailor)
- [Yaakov Dahan](https://github.com/yakidahan) ([Original Source Package](https://github.com/yadahan/laravel-authentication-log))
- [All Contributors](../../contributors)

## License

The MIT License (MIT). Please see [License File](LICENSE.md) for more information.
